name: Migrate DB (Config -> Azure Table)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/backend/requirements.txt

      - name: Log in to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch App Settings (Storage & Config)
        id: fetch-settings
        run: |
          # 1. Find Resource Group for the Function App
          RESOURCE_GROUP=$(az functionapp list --query "[?name=='${{ secrets.AZURE_FUNCTION_APP_NAME }}'].resourceGroup" -o tsv)
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "Error: Could not find Resource Group for Function App '${{ secrets.AZURE_FUNCTION_APP_NAME }}'"
            exit 1
          fi
          
          echo "Found Resource Group: $RESOURCE_GROUP"

          # 2. Fetch the storage account URL
          STORAGE_ACCOUNT_URL=$(az functionapp config appsettings list \
            --name ${{ secrets.AZURE_FUNCTION_APP_NAME }} \
            --resource-group $RESOURCE_GROUP \
            --query "[?name=='STORAGE_ACCOUNT_URL'].value" -o tsv)
          
          if [ -z "$STORAGE_ACCOUNT_URL" ]; then
            echo "Error: STORAGE_ACCOUNT_URL not found in Function App settings."
            exit 1
          fi
          
          echo "::add-mask::$STORAGE_ACCOUNT_URL"
          echo "STORAGE_ACCOUNT_URL=$STORAGE_ACCOUNT_URL" >> $GITHUB_ENV

          # 3. Fetch APP_CONFIG_JSON
          APP_CONFIG_JSON=$(az functionapp config appsettings list \
            --name ${{ secrets.AZURE_FUNCTION_APP_NAME }} \
            --resource-group $RESOURCE_GROUP \
            --query "[?name=='APP_CONFIG_JSON'].value" -o tsv)

          if [ -z "$APP_CONFIG_JSON" ]; then
            echo "Error: APP_CONFIG_JSON not found in Function App settings."
            exit 1
          fi

          # Masking strictly sensitive parts is hard for JSON, but we can try masking the whole thing or rely on secrets scanning if it was a secret.
          # For now, just set it as env var.
          echo "APP_CONFIG_JSON<<EOF" >> $GITHUB_ENV
          echo "$APP_CONFIG_JSON" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run Migration Script
        env:
          PYTHONPATH: src/backend
        run: python scripts/migrate_config_to_db.py
